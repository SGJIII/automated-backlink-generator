{% extends "base.html" %}

{% block title %}Campaign Websites{% endblock %}

{% block content %}
<h1>{{ campaign.name }} - Websites</h1>
<button id="start-analysis" class="btn btn-primary mb-3">Start Analysis</button>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>URL</th>
            <th>Domain Authority</th>
            <th>Author Name</th>
            <th>Author Email</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="websites-table-body">
        {% for website in campaign.websites %}
        <tr>
            <td>{{ website.url }}</td>
            <td>{{ website.domain_authority or 'N/A' }}</td>
            <td>{{ website.author_name or 'Not found' }}</td>
            <td>{{ website.author_email or 'Not found' }}</td>
            <td>{{ website.status }}</td>
            <td>
                {% if website.status == 'email_found' %}
                <a href="{{ url_for('begin_outreach', campaign_id=campaign.id, website_id=0) }}".replace("/0", "/${website.id}") class="btn btn-sm btn-primary">Begin Outreach</a>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<button id="fetch-more" class="btn btn-secondary">Fetch More Websites</button>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('start-analysis').addEventListener('click', function() {
        fetch('{{ url_for("analyze_campaign", campaign_id=campaign.id) }}', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Analysis started successfully');
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    document.getElementById('fetch-more').addEventListener('click', function() {
        fetch('{{ url_for("fetch_more_websites", campaign_id=campaign.id) }}', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                data.websites.forEach(website => {
                    const row = `
                    <tr>
                        <td>${website.url}</td>
                        <td>${website.domain_authority}</td>
                        <td>${website.author_name}</td>
                        <td>${website.author_email}</td>
                        <td>${website.status}</td>
                        <td>
                            ${website.status === 'email_found' ? `<a href="{{ url_for('begin_outreach', campaign_id=campaign.id, website_id=0) }}".replace("/0", "/${website.id}") class="btn btn-sm btn-primary">Begin Outreach</a>` : ''}
                        </td>
                    </tr>
                    `;
                    document.getElementById('websites-table-body').insertAdjacentHTML('beforeend', row);
                });
            } else {
                alert('Error: ' + data.message);
            }
        });
    });
</script>
{% endblock %}
